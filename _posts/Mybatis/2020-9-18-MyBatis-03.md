---
layout: post
title: "MyBatis-03"
subtitle: "「连接池、事务控制」"
author: "月明"
date:  2020-09-18 22:10:00
header-img: "assets/background2.png"
header-mask: 0.3
tags:
  - FramWork
  - MyBatis
---

# MyBatis

## 连接池

> Mybatis 中也有连接池技术，但是它采用的是自己的连接池技术。在 Mybatis 的 SqlMapConfig.xml 配置文件中，通过<dataSource type="pooled">来实现 Mybatis 中连接池的配置。

![](https://pic.downk.cc/item/5fbcf1b3b18d62711343f91e.png)

![](https://pic.downk.cc/item/5fbcf1cdb18d62711343fce6.png)

### **Mybatis**中连接的获取过程分析

当我们需要创建 `SqlSession `对象并需要执行 SQL 语句时，这时候 MyBatis 才会去调用 dataSource 对象来创建java.sql.Connection对象。也就是说，java.sql.Connection对象的创建一直延迟到执行SQL语句的时候。

## 事务控制

在 JDBC 中我们可以通过手动方式将事务的提交改为手动方式，通过 setAutoCommit()方法就可以调整。

Mybatis 中事务的提交方式，本质上就是调用 JDBC 的 setAutoCommit()来实现事务控制。

![](https://pic.downk.cc/item/5fbcf6b6b18d627113452990.jpg)

### **自动提交事务的设置**

主要原因就是在连接池中取出的连接，都会将调用 connection.setAutoCommit(`false`)方法，这样我们就必须使用 sqlSession.commit()方法，相当于使用了 JDBC 中的 connection.commit()方法实现事务提交。

```java
session = factory.openSession(true);
```

## **动态** **SQL** **语句**

### **简化编写的** **SQL** **片段**

> Sql 中可将重复的 sql 提取出来，使用时用 include 引用即可，最终达到 sql 重用的目的。

```xml
<!-- 抽取重复的语句代码片段 --> 
<sql id="defaultSql">
	select * from user
</sql>
```

* <if>标签

```xml
<select id="findByUser" resultType="user" parameterType="user">
	select * from user where 1=1
<if test="username!=null and username != '' ">
	and username like #{username}
</if> 
<if test="address != null">
	and address like #{address}
</if>
</select>
```

<if>标签的 `test `属性中写的是对象的`属性名`，如果是包装类的对象要使用 OGNL 表达式的写法。另外要注意 `where 1=1 `的作用~！

* <where>标签

> 为了简化上面 where 1=1 的条件拼装，我们可以采用<where>标签来简化开发。

```xml
<!-- 根据用户信息查询 --> 
<select id="findByUser" resultType="user" parameterType="user"> <include refid="defaultSql"></include> 
    <where> 
        <if test="username!=null and username != '' ">
			and username like #{username}
		</if> 
        <if test="address != null">
			and address like #{address}
		</if>
	</where>
</select>
```

* <foreach>标签

在进行范围查询时，就要将一个集合中的值，作为参数动态添加进来

```xml
<!-- 查询所有用户在 id 的集合之中 --> 
<select id="findInIds" resultType="user" parameterType="queryvo">
<!-- select * from user where id in (1,2,3,4,5); --> 
<include refid="defaultSql"></include> 
    <where> 
        <if test="ids != null and ids.size() > 0"> 
            <foreach collection="ids" open="id in ( " close=")" 					item="uid" separator=","> 
                #{uid}
			</foreach>
		</if>
	</where>
</select>
```

> SQL 语句：select 字段 from user where id in (?)
>
> <foreach>标签用于遍历集合，它的属性：
>
> `collection`:代表要遍历的集合元素，注意编写时不要写#{}
>
> `open`:代表语句的`开始`部分
>
> `close`:代表`结束`部分
>
> `item`:代表遍历集合的每个元素，生成的`变量名`
>
> `sperator`:代表`分隔符`

## **多表查询**

